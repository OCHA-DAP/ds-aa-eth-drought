---
title: "Review of Seasons for Ethiopia"
author: "Pauline"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: false
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Rainy Season Review by Admin Level (ERA5)

This document looks at possible seasons per each admin level for Ethiopia.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(TriggerApp2024)
library(tidyverse)
library(shiny)
library(gghdx)
gghdx()
#ldf <- load_df_forecast(dataset = "mars_eth")
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
eth_files <- list.files('../data', pattern = "eth_adm")
fp_eth_files <- file.path(
  "../data",
  eth_files
)
adm_level_labels <- stringr::str_extract(eth_files,"adm\\d")

ldf <- purrr::map(
  rlang::set_names(fp_eth_files, adm_level_labels),
  \(fp_tmp){
    arrow::read_parquet(
     fp_tmp
    )
  }
)

```

## At Country Level

### Plot of Monthly Means

Using a threshold, seasons can be defined as those months having mean rainfall above the quantile.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
sliderInput("season_thresh", "Threshold Quantile for Season:", 0.4, min = 0, max = 1)
adm0_monthly_means <- reactive({
  ldf$adm0 %>%
    rename_with(tolower, everything()) %>%
    mutate(valid_month = month(time),
           month_name = factor(month.abb[valid_month], levels = month.abb)) %>%
    group_by(admin0pcode, admin0name_en, month_name) %>%
    summarise(total_value = sum(median*1000, na.rm = TRUE)) %>%
    group_by(admin0pcode, admin0name_en) %>%
    mutate(season_thresh = quantile(total_value, probs = input$season_thresh), 
           in_season = ifelse(total_value >= season_thresh, "In-Seas", ""))
})

renderPlot({
  ggplot(adm0_monthly_means(), aes(x=month_name, y=total_value, group=1)) + 
    geom_line()+
    labs(title = "Average Monthly Rainfall over Ethiopia", x = "Months", y = "Rainfall(mm)")+
    #geom_smooth(method = "loess", se = FALSE)+
    facet_wrap(~admin0name_en)
})
```

### Table Showing Whether a Month is considered in season or not

```{r, echo=FALSE, message=FALSE, warning=FALSE}
DT::renderDT({
  DT::datatable(adm0_monthly_means() %>%
    group_by(admin0pcode, admin0name_en, month_name) %>%
    summarise(adm0_inseason = sum(in_season == "In-Seas") / n()) %>%
    dplyr::select(month_name, adm0_inseason) %>% 
    filter(adm0_inseason >= 0.5) %>%
    group_by(admin0pcode, admin0name_en) %>%
    summarise(concat_months = paste(month_name, collapse = "-")) %>%
    rename(`months in season` = concat_months),
  filter = "top", options = list(pageLength = -1, rownames = FALSE))
})
```


```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
DT::renderDT({
  DT::datatable(adm0_monthly_means() %>%
    dplyr::select(month_name, in_season) %>% 
    pivot_wider(names_from = month_name, values_from = in_season), 
    filter = "top", options = list(rownames = FALSE))
})
```

## At Regional Level

### Plot of Monthly Means

```{r, echo=FALSE, message=FALSE, warning=FALSE}
adm1_monthly_means <- reactive({
  ldf$adm1 %>%
    rename_with(tolower, everything()) %>%
    mutate(valid_month = month(time),
           month_name = factor(month.abb[valid_month], levels = month.abb)) %>%
    group_by(admin1pcode, admin1name_en, month_name) %>%
    summarise(total_value = sum(median*1000, na.rm = TRUE)) %>%
    group_by(admin1pcode, admin1name_en) %>%
    mutate(season_thresh = quantile(total_value, probs = input$season_thresh), 
           in_season = ifelse(total_value >= season_thresh, "In-Seas", ""))
})

renderPlot({
  ggplot(adm1_monthly_means(), aes(x=month_name, y=total_value, group=1)) + 
    geom_line()+
    labs(title = "Average Monthly Rainfall over Ethiopia", x = "Months", y = "Rainfall(mm)")+
    facet_wrap(~admin1name_en, scales = "free", ncol = 3)
}, height = 800)
```

### Table Showing Whether a Month is considered in season or not

```{r, echo=FALSE, message=FALSE, warning=FALSE}
DT::renderDT({
  DT::datatable(adm1_monthly_means() %>%
    group_by(admin1pcode, admin1name_en, month_name) %>%
    summarise(adm1_inseason = sum(in_season == "In-Seas") / n()) %>%
    dplyr::select(month_name, adm1_inseason) %>% 
    filter(adm1_inseason == 1) %>%
    group_by(admin1pcode, admin1name_en) %>%
    summarise(concat_months = paste(month_name, collapse = "-")) %>%
    rename(`months in season` = concat_months),
  filter = "top", options = list(pageLength = -1, rownames = FALSE))
}, width = "80%")
```


```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
DT::renderDT({
  DT::datatable(adm1_monthly_means() %>%
    dplyr::select(month_name, in_season) %>% 
    pivot_wider(names_from = month_name, values_from = in_season),
    filter = "top", options = list(pageLength = -1, rownames = FALSE))
}, width = "80%")
```

## At Zonal Level

```{r, echo=FALSE, message=FALSE, warning=FALSE}
adm2_monthly_means <- reactive({
  ldf$adm2 %>%
    rename_with(tolower, everything()) %>%
    filter(!(admin1name_en %in% c("Min", "Max"))) %>%
    mutate(valid_month = month(time),
           month_name = factor(month.abb[valid_month], levels = month.abb)) %>%
    group_by(admin1pcode, admin1name_en, admin2pcode, admin2name_en, month_name) %>%
    summarise(total_value = sum(median*1000, na.rm = TRUE)) %>%
    group_by(admin1pcode, admin1name_en, admin2pcode, admin2name_en) %>%
    mutate(season_thresh = quantile(total_value, probs = input$season_thresh), 
           in_season = ifelse(total_value >= season_thresh, "In-Seas", ""))
})
```

### Plot of Monthly Means

```{r, echo=FALSE, message=FALSE, warning=FALSE}
renderPlot({
  ggplot(adm2_monthly_means(), aes(x=month_name, y=total_value, group=admin2pcode)) + 
    geom_line()+
    labs(title = "Average Monthly Rainfall over Ethiopia", x = "Months", y = "Rainfall(mm)")+
    facet_wrap(~admin1name_en, scales = "free", ncol = 3)
}, height = 800)
```


### Table Showing Whether a Month is considered in season or not

This looks at months where percent of zones in the region have the rainfall mean above the threshold set above.

#### By Admin 1

```{r, echo=FALSE, message=FALSE, warning=FALSE}
sliderInput("zonal_thresh", "Percent of Zones to consider:", 0.6, min = 0, max = 1)

DT::renderDT({
  DT::datatable(adm2_monthly_means() %>%
    group_by(admin1pcode, admin1name_en, month_name) %>%
    summarise(adm2_inseason = sum(in_season == "In-Seas") / n()) %>%
    dplyr::select(month_name, adm2_inseason) %>% 
    filter(adm2_inseason >= input$zonal_thresh) %>%
    group_by(admin1pcode, admin1name_en) %>%
    summarise(concat_months = paste(month_name, collapse = "-")) %>%
    rename(`months in season` = concat_months),
  filter = "top", options = list(pageLength = -1, rownames = FALSE))
})
```

#### By Admin 2

```{r, echo=FALSE, message=FALSE, warning=FALSE}
DT::renderDT({
  DT::datatable(adm2_monthly_means() %>%
    group_by(admin1pcode, admin1name_en, admin2pcode, admin2name_en, month_name) %>%
    summarise(adm2_inseason = sum(in_season == "In-Seas") / n()) %>%
    dplyr::select(month_name, adm2_inseason) %>% 
    filter(adm2_inseason == 1) %>%
    group_by(admin1pcode, admin1name_en, admin2pcode, admin2name_en) %>%
    summarise(concat_months = paste(month_name, collapse = "-")) %>%
    rename(`months in season` = concat_months),
  filter = "top", options = list(rownames = FALSE))
})
```


```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
DT::renderDT({
  DT::datatable(adm2_monthly_means() %>%
    dplyr::select(month_name, in_season) %>% 
    pivot_wider(names_from = month_name, values_from = in_season),
    filter = "top", options = list(rownames = FALSE))
}, width = "80%")
```

## At Woreda Level

```{r, echo=FALSE, message=FALSE, warning=FALSE}
adm3_monthly_means <- reactive({
  ldf$adm3 %>%
    rename_with(tolower, everything()) %>%
    filter(!(admin1name_en %in% c("Min", "Max"))) %>%
    mutate(valid_month = month(time),
           month_name = factor(month.abb[valid_month], levels = month.abb)) %>%
    group_by(admin1pcode, admin1name_en, admin2pcode, admin2name_en, admin3pcode, admin3name_en, month_name) %>%
    summarise(total_value = sum(median*1000, na.rm = TRUE)) %>%
    group_by(admin1pcode, admin1name_en, admin2pcode, admin2name_en, admin3pcode, admin3name_en) %>%
    mutate(season_thresh = quantile(total_value, probs = input$season_thresh), 
           in_season = ifelse(total_value >= season_thresh, "In-Seas", ""))
})
```

### Plot of Monthly Means

```{r, echo=FALSE, message=FALSE, warning=FALSE}
renderPlot({
  ggplot(adm3_monthly_means(), aes(x=month_name, y=total_value, group=admin3pcode)) + 
    geom_line()+
    labs(title = "Average Monthly Rainfall over Ethiopia", x = "Months", y = "Rainfall(mm)")+
    facet_wrap(~admin1name_en, scales = "free", ncol = 3)
}, height = 800)
```

### Table Showing Whether a Month is considered in season or not

This looks at months where percent of zones in the region have the rainfall mean above the threshold set above. The months are those that have a percent of the woredas where the rainfall is above the set quantile.

#### By Admin 1

```{r, echo=FALSE, message=FALSE, warning=FALSE}
sliderInput("woreda_thresh", "Percent of Woredas to consider:", 0.6, min = 0, max = 1)

DT::renderDT({
  DT::datatable(adm3_monthly_means() %>%
    group_by(admin1pcode, admin1name_en, month_name) %>%
    summarise(adm3_inseason = sum(in_season == "In-Seas") / n()) %>%
    dplyr::select(month_name, adm3_inseason) %>% 
    filter(adm3_inseason >= input$woreda_thresh) %>%
    group_by(admin1pcode, admin1name_en) %>%
    summarise(concat_months = paste(month_name, collapse = "-")) %>%
    rename(`months in season` = concat_months),
  filter = "top", options = list(pageLength = -1, rownames = FALSE))
})
```

#### By Admin 2

```{r, echo=FALSE, message=FALSE, warning=FALSE}
DT::renderDT({
  DT::datatable(adm3_monthly_means() %>%
    group_by(admin1pcode, admin1name_en, admin2pcode, admin2name_en, month_name) %>%
    summarise(adm3_inseason = sum(in_season == "In-Seas") / n()) %>%
    dplyr::select(month_name, adm3_inseason) %>% 
    filter(adm3_inseason >= input$woreda_thresh) %>%
    group_by(admin1pcode, admin1name_en, admin2pcode, admin2name_en) %>%
    summarise(concat_months = paste(month_name, collapse = "-")) %>%
    rename(`months in season` = concat_months),
  filter = "top", options = list(rownames = FALSE))
})
```

#### By Admin 3

```{r, echo=FALSE, message=FALSE, warning=FALSE}
DT::renderDT({
  DT::datatable(adm3_monthly_means() %>%
    group_by(admin1pcode, admin1name_en, admin2pcode, admin2name_en, admin3pcode, admin3name_en, month_name) %>%
    summarise(adm3_inseason = sum(in_season == "In-Seas") / n()) %>%
    dplyr::select(month_name, adm3_inseason) %>% 
    filter(adm3_inseason == 1) %>%
    group_by(admin1pcode, admin1name_en, admin2pcode, admin2name_en, admin3pcode, admin3name_en) %>%
    summarise(concat_months = paste(month_name, collapse = "-")) %>%
    rename(`months in season` = concat_months),
  filter = "top", options = list(rownames = FALSE))
})
```


```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
DT::renderDT({
  DT::datatable(adm3_monthly_means() %>%
    dplyr::select(month_name, in_season) %>% 
    pivot_wider(names_from = month_name, values_from = in_season),
    filter = "top", options = list(rownames = FALSE))
}, width = "80%")
```
