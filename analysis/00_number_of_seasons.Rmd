---
title: "Number of Seasons"
author: "Pauline"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

For this notebook, we want to compute the number of seasons for each woreda. We also look at the seasons for a woreda from: <https://agricultural-production-hotspots.ec.europa.eu/download.php>

```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(tidyverse)
library(scales)
library(raster)
library(sf)
library(gghdx)
gghdx()
```

```{r echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
eth_adm3_codab <- st_read(
  file.path(
    Sys.getenv("AA_DATA_DIR"),
    "public", "raw", "eth", "cod_ab", "Admin_2024.gdb.zip"), 
  layer = "eth_admbnda_adm3_csa_bofedb_2024")
eth_adm2_codab <- st_read(
  file.path(
    Sys.getenv("AA_DATA_DIR"),
    "public", "raw", "eth", "cod_ab", "Admin_2024.gdb.zip"), 
  layer = "eth_admbnda_adm2_csa_bofedb_2024")
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
pheno_vec <- c("phenonseasons_v03.tif", "phenos1_v03.tif", "phenoe1_v03.tif", "phenos2_v03.tif", "phenoe2_v03.tif", "phenosen1_v03.tif", "phenosen2_v03.tif")

process_rasters <- pheno_vec %>%
  set_names() %>%
  map(\(pheno_obj) {
    pheno_raster <- raster(
      file.path(
        Sys.getenv("AA_DATA_DIR"),
        "public", "raw", "glb", "asap", 
        "reference_data", pheno_obj))
    eth_season_crop <- crop(pheno_raster, extent(eth_adm2_codab))
    eth_season_mask <- mask(eth_season_crop, eth_adm2_codab)
    eth_season_mask[eth_season_mask > 108] <- NA
    eth_adm2_seasons <- raster::extract(eth_season_mask, eth_adm2_codab, fun=median, na.rm = T)[,1]
    return(round(eth_adm2_seasons))
  }) 

```

```{r echo=FALSE, message=FALSE, warning=FALSE}
process_dekads <- function(column){
  start_date <- ymd("2023-01-01")
  dekads <- case_when(column <= 36 ~ column,
            between(column, 37, 72) ~ column - 36,
            column > 72 ~ column - 72,
            .default = column)
  dekad_dates <- if_else(dekads %% 3 != 0, 
                         start_date + months(dekads %/% 3) + days(((dekads %% 3)*10)-10),
                         start_date + months((dekads %/% 3)-1) + days(20))
  month_names <- month(dekad_dates, label = TRUE)
  return(dekad_dates)
}
```

Showing the number of seasons by Woreda

```{r echo=FALSE, message=FALSE, warning=FALSE}
eth_seasons <- eth_adm2_codab %>%
  bind_cols(process_rasters %>% 
              bind_cols()) %>%
  mutate(start1_mon = process_dekads(phenos1_v03.tif),
         sen1_mon = process_dekads(phenosen1_v03.tif),
         end1_mon = process_dekads(phenoe1_v03.tif),
         start2_mon = process_dekads(phenos2_v03.tif),
         sen2_mon = process_dekads(phenosen2_v03.tif),
         end2_mon = process_dekads(phenoe2_v03.tif))

write_csv(eth_seasons %>% st_drop_geometry(), "G:/Shared drives/Predictive Analytics/CERF Anticipatory Action/Ethiopia/2024/Trigger Development/asap_seasons_zones.csv")
```

```{r echo=FALSE, message=FALSE, warning=FALSE}

ggplot(data = eth_seasons) +
  geom_sf(aes(fill = factor(`phenonseasons_v03.tif`), geometry = Shape)) + 
  labs(title = "Number of Seasons by Woreda",
       fill = "Number of Seasons")

```

Start of First Season

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(data = eth_seasons) +
  geom_sf(aes(fill = month(start1_mon, label = TRUE), geometry = Shape)) + 
  labs(title = "Start of First Season by Woreda",
       fill = "Month")

```

Start of senescence, First season

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(data = eth_seasons) +
  geom_sf(aes(fill = month(sen1_mon, label = TRUE), geometry = Shape)) + 
  labs(title = "Start of senescence, First season by Woreda",
       fill = "Month") 

```

End of First Season

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(data = eth_seasons) +
  geom_sf(aes(fill = month(end1_mon, label = TRUE), geometry = Shape)) + 
  labs(title = "End of First Season by Woreda",
       fill = "Month") 

```

Start of Second Season

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(data = eth_seasons %>% filter(!admin2Name_en %in% c("Min", "Max"))) +
  geom_sf(aes(fill = month(start2_mon, label = TRUE), geometry = Shape)) + 
  labs(title = "Start of Second Season by Zone",
       fill = "Month") 

```

Start of senescence, Second season

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(data = eth_seasons %>% filter(!admin2Name_en %in% c("Min", "Max"))) +
  geom_sf(aes(fill = month(sen2_mon, label = TRUE), geometry = Shape)) + 
  labs(title = "Start of senescence, Second season by Zone",
       fill = "Month") 

```

End of Second Season

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(data = eth_seasons) +
  geom_sf(aes(fill = month(end2_mon, label = TRUE), geometry = Shape)) + 
  labs(title = "End of Second Season by Woreda",
       fill = "Month") 

```

Most common start of senescence months for the first season based on the start month

```{r echo=FALSE, message=FALSE, warning=FALSE}
eth_seasons %>%
  filter(!is.na(phenonseasons_v03.tif)) %>%
  ggplot(aes(x = start1_mon, fill = month(sen1_mon, label = T))) +
    geom_bar(position = "dodge", stat = "count") + 
    labs(title = "Most common start of senescence months for the first season based on the start month",
         x = "Month", fill = "") +
  scale_x_date(labels = date_format("%b %d"))

```

Most common end months for the first season based on the start month

```{r echo=FALSE, message=FALSE, warning=FALSE}
eth_seasons %>%
  filter(!is.na(phenonseasons_v03.tif)) %>%
  ggplot(aes(x = start1_mon, fill = month(end1_mon, label = T))) +
    geom_bar(position = "dodge", stat = "count") + 
    labs(title = "Most common end months for the first season based on the start month",
         x = "Month", fill = "") +
  scale_x_date(labels = date_format("%b %d"))

```

Most common start of senescence months for the second season based on the start month

```{r echo=FALSE, message=FALSE, warning=FALSE}
eth_seasons %>%
  filter(!is.na(phenonseasons_v03.tif) & phenonseasons_v03.tif == 2) %>%
  ggplot(aes(x = start2_mon, fill = month(sen2_mon, label = T))) +
    geom_bar(position = "dodge", stat = "count") + 
    labs(title = "Most common start of senescence months for the second season based on the start month",
         x = "Month", fill = "") +
  scale_x_date(labels = date_format("%b %d"))

```

Most common end months for the second season based on the start month

```{r echo=FALSE, message=FALSE, warning=FALSE}
eth_seasons %>%
  filter(!is.na(phenonseasons_v03.tif) & phenonseasons_v03.tif == 2) %>%
  ggplot(aes(x = start2_mon, fill = month(end2_mon, label = T))) +
    geom_bar(position = "dodge", stat = "count") + 
    labs(title = "Most common end months for the second season based on the start month",
         x = "Month", fill = "") +
  scale_x_date(labels = date_format("%b %d"))

```

```{r echo=FALSE, message=FALSE, warning=FALSE}
eth_seasons <- eth_seasons %>%
  mutate(season1 = case_when(phenonseasons_v03.tif == 1 ~ "JJAS",
                                       phenonseasons_v03.tif == 2 ~ "MAM",
                                       .default = NA),
         season2 = case_when(phenonseasons_v03.tif == 2 ~ "OND",
                                       .default = NA))

write_csv(st_drop_geometry(eth_seasons) %>%
            dplyr::select(admin3Name_en, admin3Pcode,
                   admin2Name_en, admin2Pcode, 
                   admin1Name_en, admin1Pcode, 
                   phenonseasons_v03.tif, season1, season2),
          "G:/Shared drives/Predictive Analytics/CERF Anticipatory Action/Ethiopia/2024/Trigger Development/seasons_for_woredas.csv")
```

MAM

```{r echo=FALSE, message=FALSE, warning=FALSE}
eth_seasons %>%
  mutate(season1_mam = case_when(season1 != "MAM" ~ NA,
                                 .default = season1)) %>%
  ggplot() +
    geom_sf(aes(fill = season1_mam, geometry = Shape)) + 
    labs(title = "Woredas that have MAM season for the first season",
         fill = "Month") +
  guides(fill = "none")

```

JJAS

```{r echo=FALSE, message=FALSE, warning=FALSE}
eth_seasons %>%
  mutate(season1_jjas = case_when(season1 != "JJAS" ~ NA,
                                 .default = season1)) %>%
  ggplot() +
    geom_sf(aes(fill = season1_jjas, geometry = Shape)) + 
    labs(title = "Woredas that have JJAS season",
         fill = "Month") +
  guides(fill = "none")

```

OND

```{r echo=FALSE, message=FALSE, warning=FALSE}
eth_seasons %>%
  mutate(season2_ond = case_when(season2 != "OND" ~ NA,
                                 .default = season2)) %>%
  ggplot() +
    geom_sf(aes(fill = season2_ond, geometry = Shape)) + 
    labs(title = "Woredas that have OND season",
         fill = "Month") +
  guides(fill = "none")

```
