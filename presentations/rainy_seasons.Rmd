---
title: "Review of Seasons for Ethiopia"
author: "Pauline"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: false
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Rainy Season Review by Admin Level

This document looks at possible seasons per each admin level for Ethiopia.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(TriggerApp2024)
library(tidyverse)
library(shiny)
library(gghdx)
gghdx()
#ldf <- load_df_forecast(dataset = "mars_eth")
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
eth_files <- stringr::str_subset(list.files('../data'), pattern = "eth")
fp_eth_files <- file.path(
  "../data",
  eth_files
)
adm_level_labels <- stringr::str_extract(eth_files,"adm\\d")

ldf <- purrr::map(
  rlang::set_names(fp_eth_files, adm_level_labels),
  \(fp_tmp){
    arrow::read_parquet(
     fp_tmp
    )
  }
)

```

## At Country Level

### Plot of Monthly Forecast Means

Using a threshold, seasons can be defined as those months having mean rainfall above the quantile.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
sliderInput("season_thresh", "Threshold Quantile for Season:", 0.4, min = 0, max = 1)
adm0_monthly_means <- reactive({
  ldf$adm0 %>%
  mutate(month_name = factor(month.abb[valid_month], levels = month.abb)) %>%
  group_by(adm0_pcode, adm0_en, month_name) %>%
  summarise(mean_value = mean(value, na.rm = TRUE)) %>%
  group_by(adm0_pcode, adm0_en) %>%
  mutate(season_thresh = quantile(mean_value, probs = input$season_thresh), 
         in_season = ifelse(mean_value >= season_thresh, "In-Seas", ""))
})

renderPlot({
  ggplot(adm0_monthly_means(), aes(x=month_name, y=mean_value, group=1)) + 
    geom_line()+
    labs(title = "Average Forecasted Monthly Rainfall over Ethiopia", x = "Months", y = "Rainfall(mm)")+
    #geom_smooth(method = "loess", se = FALSE)+
    facet_wrap(~adm0_en)
})
```

### Table Showing Whether a Month is considered in season or not

```{r, echo=FALSE, message=FALSE, warning=FALSE}
DT::renderDT({
  DT::datatable(adm0_monthly_means() %>%
    select(month_name, in_season) %>% 
    pivot_wider(names_from = month_name, values_from = in_season), 
    filter = "top")
})
```

## At Regional Level

### Plot of Monthly Forecast Means

```{r, echo=FALSE, message=FALSE, warning=FALSE}
adm1_monthly_means <- reactive({
  ldf$adm1 %>%
  mutate(month_name = factor(month.abb[valid_month], levels = month.abb)) %>%
  group_by(adm1_pcode, adm1_en, month_name) %>%
  summarise(mean_value = mean(value, na.rm = TRUE)) %>%
  group_by(adm1_pcode, adm1_en) %>%
  mutate(season_thresh = quantile(mean_value, probs = input$season_thresh), 
         in_season = ifelse(mean_value >= season_thresh, "In-Seas", ""))
})

renderPlot({
  ggplot(adm1_monthly_means(), aes(x=month_name, y=mean_value, group=1)) + 
    geom_line()+
    labs(title = "Average Forecasted Monthly Rainfall over Ethiopia", x = "Months", y = "Rainfall(mm)")+
    facet_wrap(~adm1_en, scales = "free", ncol = 3)
})
```

### Table Showing Whether a Month is considered in season or not

```{r, echo=FALSE, message=FALSE, warning=FALSE}
DT::renderDT({
  DT::datatable(adm1_monthly_means() %>%
    select(month_name, in_season) %>% 
    pivot_wider(names_from = month_name, values_from = in_season),
    filter = "top", options = list(pageLength = -1))
})
```

## At Zonal Level

```{r, echo=FALSE, message=FALSE, warning=FALSE}
adm2_monthly_means <- reactive({
  ldf$adm2 %>%
  mutate(month_name = factor(month.abb[valid_month], levels = month.abb)) %>%
  group_by(adm1_pcode, adm1_en, adm2_pcode, adm2_en, month_name) %>%
  summarise(mean_value = mean(value, na.rm = TRUE)) %>%
  group_by(adm1_pcode, adm1_en, adm2_pcode, adm2_en) %>%
  mutate(season_thresh = quantile(mean_value, probs = input$season_thresh), 
         in_season = ifelse(mean_value >= season_thresh, "In-Seas", ""))
})
```

### Table Showing Whether a Month is considered in season or not

This looks at months where percent of zones in the region have the rainfall mean above the threshold set above.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
sliderInput("zonal_thresh", "Percent of Zones to consider:", 0.8, min = 0, max = 1)

DT::renderDT({
  DT::datatable(adm2_monthly_means() %>%
  group_by(adm1_pcode, adm1_en, month_name) %>%
  summarise(adm2_inseason = sum(in_season == "In-Seas") / n()) %>%
  select(month_name, adm2_inseason) %>% 
  filter(adm2_inseason >= input$zonal_thresh) %>%
  group_by(adm1_pcode, adm1_en) %>%
  summarise(concat_months = paste(month_name, collapse = "-")),
    filter = "top", options = list(pageLength = -1))
})
```

## At Woreda Level

```{r, echo=FALSE, message=FALSE, warning=FALSE}
adm3_monthly_means <- reactive({
  ldf$adm3 %>%
  mutate(month_name = factor(month.abb[valid_month], levels = month.abb)) %>%
  group_by(adm1_pcode, adm1_en, adm2_pcode, adm2_en, adm3_pcode, adm3_en, month_name) %>%
  summarise(mean_value = mean(value, na.rm = TRUE)) %>%
  group_by(adm1_pcode, adm1_en, adm2_pcode, adm2_en, adm3_pcode, adm3_en) %>%
  mutate(season_thresh = quantile(mean_value, probs = input$season_thresh), 
         in_season = ifelse(mean_value >= season_thresh, "In-Seas", ""))
})
```

### Table Showing Whether a Month is considered in season or not

This looks at months where percent of zones in the region have the rainfall mean above the threshold set above. The months are those that have a percent of the woredas where the rainfall is above the set quantile.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
sliderInput("woreda_thresh", "Percent of Woredas to consider:", 0.8, min = 0, max = 1)

DT::renderDT({
  DT::datatable(adm3_monthly_means() %>%
  group_by(adm1_pcode, adm1_en, month_name) %>%
  summarise(adm3_inseason = sum(in_season == "In-Seas") / n()) %>%
  select(month_name, adm3_inseason) %>% 
  filter(adm3_inseason >= input$woreda_thresh) %>%
  group_by(adm1_pcode, adm1_en) %>%
  summarise(concat_months = paste(month_name, collapse = "-")),
    filter = "top", options = list(pageLength = -1))
})
```
